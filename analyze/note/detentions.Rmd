---
title: "ICE ERO-LESA detention data Nov. 2023-Feb. 2025"
author: "UWCHR"
date: "2025-03-25"
output:
    html_document:
        html_preview: true
        toc: true
        toc_depth: 3
        toc_float: true
        code_folding: hide
---


```{r setup, message=FALSE, warning=FALSE, include=TRUE}

options(scipen = 1000000)

library(pacman)

p_load(here, tidyverse, zoo, lubridate, ggplot2, plotly, gghighlight, viridis, readxl, digest)

file <- "ICE Detentions_2025-ICLI-00019_2024-ICFO-39357_LESA-STU_FINAL_raw.xlsx"

df <- read_excel(here('analyze', 'input', file), skip=6) %>% 
  janitor::clean_names() %>% 
  mutate(stay_book_in_date_time = ymd_hms(stay_book_in_date_time),
         book_in_date_time = ymd_hms(book_in_date_time),
         detention_book_out_date_time = ymd_hms(detention_book_out_date_time),
         stay_book_out_date_time = ymd_hms(stay_book_out_date_time),
         )

```

```{r missingness}

sum(is.na(df$unique_identifier))
sum(is.na(df$stay_book_in_date_time))
sum(is.na(df$book_in_date_time))
sum(is.na(df$detention_book_out_date_time))
sum(is.na(df$stay_book_out_date_time))
sum(is.na(df$detention_facility))

```

```{r gen_hash}

vdigest <- Vectorize(digest)

df <- df %>% rowwise() %>% 
  unite(allCols, sep = "", remove = FALSE) %>% 
  unite(stayCols, c(unique_identifier, stay_book_in_date_time), sep = "", remove = FALSE) %>% 
  mutate(recid = vdigest(allCols),
         stayid = vdigest(stayCols)) %>%
  select(-c(allCols, stayCols))

```

```{r unique_ids}

length(unique(df$unique_identifier))

sum(is.na(df$unique_identifier))

```

```{r}

max_date <- as.Date("2025-02-18")

df <- df %>% 
  filter(!is.na(stay_book_in_date_time),
         !is.na(book_in_date_time)) %>% 
  mutate(stay_length = difftime(stay_book_out_date_time,
            stay_book_in_date_time, unit='days'),
         placement_length = difftime(detention_book_out_date_time,
            book_in_date_time, unit='days'),
         stay_length_min = difftime(replace_na(stay_book_out_date_time, max_date),
            stay_book_in_date_time, unit='days'),
         placement_length_min = difftime(replace_na(detention_book_out_date_time, max_date),
            book_in_date_time, unit='days'))

df <- df %>% 
  filter(!is.na(unique_identifier)) %>% 
  group_by(unique_identifier) %>% 
  arrange(stay_book_in_date_time, book_in_date_time) %>%
  mutate(total_stays = n_distinct(stay_book_in_date_time),
         total_placements = n(),
         current_stay = is.na(stay_book_out_date_time),
         current_placement = is.na(detention_book_out_date_time),
         stay_count = data.table::rleid(stay_book_in_date_time)) %>% 
  ungroup()

df <- df %>% 
  group_by(stayid) %>% 
  arrange(stay_book_in_date_time, book_in_date_time) %>%
  mutate(placement_count = data.table::rleid(recid),
         stay_placements = n(),
         first_facil = detention_facility_code[[1]], 
         last_facil = detention_facility_code[[length(detention_facility_code)]],
         longest_placement_facil = detention_facility_code[which.max(placement_length_min)],
         last_placement = placement_count == stay_placements,
         longest_placement = placement_length_min == max(placement_length_min)
         ) %>% 
  ungroup()

```


```{r known_facilities}

known_facil <- read_delim(here::here('analyze', 'input', 'facilities.csv.gz'), delim ='|')

df <- df %>% 
  mutate(known_facil = detention_facility_code %in% unique(known_facil$detloc))

# Most detention records involve known facilities (NIJC 2017 + UWCHR)
sum(df$known_facil) / nrow(df)

# List of "new" facilities
unknown_facil <- unique(df[df$known_facil == FALSE, c("detention_facility_code", "detention_facility")]) %>% 
  arrange(detention_facility)

```

```{r get_wa_arrests}

file <- "ERO Admin Arrests_2025-ICLI-00019_2024-ICFO-39357_LESA-STU_FINAL_raw.xlsx"

arr <- read_excel(here('analyze', 'input', file), skip=6) %>% 
  janitor::clean_names() %>% 
  mutate(apprehension_date = as.Date(apprehension_date)) |>
  mutate(apprehension_method = fct(apprehension_method)) |>
  mutate(criminality = apprehension_criminality == "1 Convicted Criminal") |>
  mutate(n_dupe = row_number(), .by = c("apprehension_date", "apprehension_method", "apprehension_criminality", "unique_identifier")) |>
  filter(is.na(unique_identifier) | n_dupe == 1) |>
  mutate(week = floor_date(apprehension_date, "week", week_start = "Monday"))

to_join <- arr %>% 
  dplyr::select(unique_identifier, citizenship_country, final_program_group)

to_join <- to_join[!duplicated(to_join$unique_identifier), ]

df <- df %>% left_join(to_join, by='unique_identifier')

wa_arr <- arr %>% 
  filter(apprehension_state == "WASHINGTON")

```

```{r wa_detentions}

wa_det <- df %>% 
  filter(unique_identifier %in% unlist(wa_arr$unique_identifier))

wa_det %>% 
  count(detention_facility) %>% 
  arrange(desc(n))

wa_det %>% 
  count(first_facil) %>% 
  arrange(desc(n))

```

```{r headcounter_setup, message=FALSE, warning=FALSE, include=TRUE}

# Transform data to "fill in" missing `detention_book_out_date_time` values
# in order to account for ongong detention stays at time of release of data
max_date <- max(df$stay_book_out_date_time, na.rm=TRUE)

df <- df %>%
  mutate(detention_book_out_date_time_min = 
           case_when(is.na(detention_book_out_date_time) ~ max_date,
                     TRUE ~ detention_book_out_date_time))

# Define timeline for calculation of daily detained population
timeline_start <- min(df$stay_book_in_date_time, na.rm=TRUE)
timeline_end <- max(df$stay_book_out_date_time, na.rm=TRUE)
timeline <- seq(timeline_start, timeline_end, by='day')

# Function counts all in-range detention placement records in dataset `df` for a
# given `date` by a given grouping variable `var`
headcounter <- function(date, df, group_vars) {
  
  in_range <- df[df$book_in_date_time <= date & df$detention_book_out_date_time_min > date,]
  
  in_range %>% 
    group_by(across(all_of(group_vars))) %>% 
    summarize(n = n()) %>% 
    complete(fill = list(n = 0)) %>% 
    mutate(date=date)
  
  }

```

```{r facil_headcount_gender}

# Generate limited sample dataset
temp_df <- df %>% 
  filter(detention_facility_code == "CSCNWWA")

# Apply function to timeline
example_headcount <- lapply(timeline, headcounter, df=temp_df, group_vars=c('gender'))

# Transform output into data frame
example_headcount_data <- map_dfr(example_headcount, bind_rows)

# Plot headcount
p1 <- example_headcount_data %>% 
  filter(date >= "2023-11-15") %>% 
  ggplot(aes(x = date, y = n, color = gender), group = gender ) +
  geom_line() +
  labs(title = "Daily detained population by `gender`",
       subtitle = "Northwest ICE Processing Center")

p1

```

```{r facil_headcount_citizenship}

# Generate limited sample dataset
temp_df <- df %>% 
  filter(detention_facility_code == "CSCNWWA")

# Apply function to timeline
example_headcount <- lapply(timeline, headcounter, df=temp_df, group_vars=c('citizenship_country'))

top <- temp_df %>% 
  filter(!is.na(citizenship_country)) %>% 
  count(citizenship_country) %>% 
  arrange(desc(n)) %>% 
  head(10)

# Transform output into data frame
example_headcount_data <- map_dfr(example_headcount, bind_rows)

# Plot headcount
p1 <- example_headcount_data %>% 
  mutate(citizenship_country = case_when(citizenship_country %in% top$citizenship_country ~ citizenship_country,
                                         is.na(citizenship_country) ~ NA,
                                         TRUE ~ "ALL OTHERS"),
         date = as.Date(date)) %>%
  group_by(citizenship_country, date) %>% 
  summarize(n = sum(n)) %>% 
  filter(date >= "2023-11-15") %>% 
  ggplot(aes(x = date, y = n, color = citizenship_country), group = citizenship_country ) +
  geom_line() +
  labs(title = "Daily detained population by `citizenship_country`",
       subtitle = "Northwest ICE Processing Center")

p1

```
